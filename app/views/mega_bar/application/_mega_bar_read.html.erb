<h1><%= best_in_place @mega_display[:model_display], :header, tabindex: "1", url: @model_display_path %> </h1>


<%= form_tag @mega_display[:form_path] do |f| %>
  <%=@mf.app_wrapper.html_safe%>
  <% if @mf.separate_header_row == 'true' %>
    <% @mega_display[:displayable_fields].each do | displayable_field | %>
      <%= @mf.field_header_wrapper.html_safe%>
      <%= sortable(displayable_field[:field].field, displayable_field[:field_display].header) %>
      <%= @mf.field_header_wrapper_end.html_safe%>
    <% end %>
  <% end %>

  <% @mega_instance.each do |mega_record| %>
    <%= @mf.record_wrapper.html_safe%>
    <% @mega_display[:displayable_fields].each do | displayable_field | %>

      <% @field_display_path = MegaBar::Engine.routes.url_for(controller: '/mega_bar/field_displays', action: 'show', id: displayable_field[:field_display].id, :only_path=> true) %>

      <% if @mf.name == 'ProfileTable' %>
        <tr><th><%=  best_in_place displayable_field[:field_display], :header, path:  @field_display_path %></th><td>
      <% end %>
      <%= @mf.field_wrapper.html_safe%>
      <%
        locals = {obj: mega_record, displayable_field: displayable_field, field: displayable_field[:field], field_display: displayable_field[:field_display], options: displayable_field[:options] }
        locals[displayable_field[:data_format].class.name.downcase.sub('::', '_').sub('megabar_', '').to_sym] = displayable_field[:data_format]
        data = render template: displayable_field[:field_display].format.tableize + "/show", locals: locals
      %>


      <% if displayable_field[:field_display].link_type == 'link_field_value' && displayable_field[:field_display].format == 'textread' %>
         <a href='<%=data%>'>
      <% end %>

      <%= data %>
      <% if displayable_field[:field_display].link_type == 'link_field_value' && displayable_field[:field_display].format == 'textread' %>
         </a>
      <% end %>
      <%= @mf.field_wrapper_end.html_safe %>
      <% if @mf.name == 'ProfileTable' %>
        </td>
      <% end %>
    <% end %>
    <% if @mf.name == 'GridHtml' %>
      <td>
        <%= link_to 'Show', link_path('show', mega_record.id) %>
      </td>
      <td><%= link_to 'Edit', link_path('edit', mega_record.id) %></td>
      <td><%= link_to 'Destroy', mega_record, method: :delete, data: { confirm: 'Are you sure?' } %></td>

    <% end %>
    <%= @mf.record_wrapper_end.html_safe%>
  <% end %>

  <%=@mf.app_wrapper_end.html_safe%>
 <br><%#= submit_tag %>
<% end %>
